name: Deploy RabbitMQ

on:
  push:
    branches: [main, master]
    paths:
      - 'infra/rabbit/**'
      - '.github/workflows/deploy-rabbit.yml'
  workflow_dispatch:

env:
  SERVICE_NAME: rabbitmq
  IMAGE_NAME: swecc-rabbit
  NETWORK: prod_swecc-network

jobs:
  push_to_dockerhub:
    name: Build and Push
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull, tag, and push RabbitMQ image
        run: |
          docker pull rabbitmq:3-management
          docker tag rabbitmq:3-management ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker tag rabbitmq:3-management ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy_to_swarm:
    name: Deploy to Swarm
    needs: push_to_dockerhub
    runs-on:
      group: EC2
      labels: [self-hosted, deploy]
    steps:
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Pull latest image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy RabbitMQ service
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"

          if docker service ls | grep -q "${{ env.SERVICE_NAME }}"; then
            echo "Updating existing RabbitMQ service..."
            docker service update \
              --image "$IMAGE" \
              --update-parallelism 1 \
              --update-delay 30s \
              --update-order start-first \
              --update-failure-action rollback \
              --with-registry-auth \
              ${{ env.SERVICE_NAME }}
          else
            echo "Creating new RabbitMQ service..."
            docker service create \
              --name ${{ env.SERVICE_NAME }} \
              --network ${{ env.NETWORK }} \
              --mount type=volume,source=rabbitmq_data,target=/var/lib/rabbitmq \
              --replicas 1 \
              --restart-condition any \
              --update-parallelism 1 \
              --update-delay 30s \
              --update-order start-first \
              --update-failure-action rollback \
              --limit-cpu 0.3 \
              --limit-memory 256M \
              --reserve-cpu 0.1 \
              --reserve-memory 128M \
              --with-registry-auth \
              -p 5672:5672 \
              "$IMAGE"
          fi

      - name: Verify deployment
        run: |
          echo "Waiting for service to stabilize..."
          sleep 5

          timeout=120
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            REPLICAS=$(docker service ls --filter "name=${{ env.SERVICE_NAME }}" --format "{{.Replicas}}")
            echo "Current replica status: $REPLICAS"

            if [ "$REPLICAS" == "1/1" ]; then
              echo "✅ RabbitMQ deployed successfully"
              exit 0
            fi

            echo "⏳ Waiting... ($elapsed/$timeout seconds)"
            sleep 10
            elapsed=$((elapsed + 10))
          done

          echo "❌ Deployment verification timed out"
          docker service ps ${{ env.SERVICE_NAME }} --no-trunc
          exit 1

